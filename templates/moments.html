{% extends 'base.html' %}

{% block extra_styles %}
<style>

/* 书本式翻页视图 */
.viewer-wrap { position:relative; margin: 8px auto 18px auto; max-width: 720px; }
.viewer { position:relative; perspective: 1600px; }
.book { position:relative; width:100%; aspect-ratio: 3/2; border-radius: var(--card-radius); overflow:hidden; box-shadow: var(--shadow-md); transform-style: preserve-3d; background:#fff; touch-action: pan-y; will-change: transform; transform: translateZ(0); }
.book.is-flipping { box-shadow: var(--shadow-sm); }
.page { position:absolute; inset:0; backface-visibility: hidden; will-change: transform; transform: translateZ(0); contain: layout paint; }
.page.front { z-index:2; }
.page.back { transform: rotateY(180deg); background:#fff; }
.page-inner { position:absolute; inset:0; overflow:auto; -webkit-overflow-scrolling: touch; }
.flip-anim { animation-duration: 650ms; animation-timing-function: ease-in-out; animation-fill-mode: forwards; }
@keyframes flipNext { 0%{ transform: rotateY(0deg); } 100%{ transform: rotateY(-180deg); } }
@keyframes flipPrev { 0%{ transform: rotateY(0deg); } 100%{ transform: rotateY(180deg); } }
.slide { position:absolute; inset:0; }
.slide-out-left { animation: slideOutLeft 260ms ease both; }
.slide-out-right { animation: slideOutRight 260ms ease both; }
.slide-in-left { animation: slideInLeft 260ms ease both; }
.slide-in-right { animation: slideInRight 260ms ease both; }
@keyframes slideOutLeft { from{ transform: translateX(0); opacity:1;} to{ transform: translateX(-18%); opacity:.6;} }
@keyframes slideOutRight { from{ transform: translateX(0); opacity:1;} to{ transform: translateX(18%); opacity:.6;} }
@keyframes slideInLeft { from{ transform: translateX(18%); opacity:.6;} to{ transform: translateX(0); opacity:1;} }
@keyframes slideInRight { from{ transform: translateX(-18%); opacity:.6;} to{ transform: translateX(0); opacity:1;} }
.nav-zone { position:absolute; top:0; bottom:0; width:22%; z-index:5; }
.nav-left { left:0; }
.nav-right { right:0; }
.viewer-indicator { display:flex; justify-content:center; gap:6px; margin-top:8px; }
.dot { width:6px; height:6px; border-radius:50%; background:#dee2e6; }
.dot.active { background:#0d6efd; }
.viewer-toolbar { display:flex; justify-content:space-between; align-items:center; margin: 8px 2px 6px 2px; }
.viewer-toolbar .btn { padding:4px 10px; }

/* 朋友圈式垂直列表 */
.moments-list {
    max-width: 600px;
    margin: 0 auto;
    padding: 20px 0;
}

.moment-item {
    background: #ffffff;
    border-radius: 12px;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    transition: all 0.3s ease;
}

.moment-item:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.moment-link {
    display: block;
    text-decoration: none;
    color: inherit;
}

.moment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px 12px 20px;
    border-bottom: 1px solid #f0f0f0;
}

.moment-time {
    font-size: 14px;
    color: #666;
    font-weight: 500;
}

.favorite-icon {
    color: #ff6b6b;
    font-size: 16px;
}

.moment-content {
    padding: 16px 20px;
    font-size: 16px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
}

.moment-media {
    padding: 0 20px 20px 20px;
}

.media-container {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    max-width: 100%;
}

.media-image {
    width: 100%;
    height: auto;
    max-height: 400px;
    object-fit: cover;
    display: block;
}

.media-video {
    width: 100%;
    height: auto;
    max-height: 400px;
    object-fit: cover;
    display: block;
    border-radius: 8px;
}

.video-controls {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.6);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0;
}

.media-container:hover .video-controls {
    opacity: 1;
}

.video-controls:hover {
    background: rgba(0, 0, 0, 0.8);
    transform: translate(-50%, -50%) scale(1.1);
}

.play-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.6);
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 24px;
}

/* 移动端响应式 */
@media (max-width: 768px) {
    .moments-list {
        padding: 10px;
        max-width: 100%;
    }
    
    .moment-item {
        margin-bottom: 12px;
        border-radius: 8px;
    }
    
    .moment-header {
        padding: 12px 16px 8px 16px;
    }
    
    .moment-time {
        font-size: 13px;
    }
    
    .moment-content {
        padding: 12px 16px;
        font-size: 15px;
    }
    
    .moment-media {
        padding: 0 16px 16px 16px;
    }
    
    .media-image {
        max-height: 300px;
    }
    
    .media-video {
        max-height: 300px;
    }
    
    .video-controls {
        width: 50px;
        height: 50px;
        font-size: 20px;
    }
    
    .play-overlay {
        width: 50px;
        height: 50px;
        font-size: 20px;
    }
}
.grid-img { 
    width: 100%; 
    aspect-ratio: 1/1; 
    object-fit: cover; 
    display: block;
    transition: transform 0.3s ease;
}

.grid-item:hover .grid-img {
    transform: scale(1.05);
}

.grid-badge { 
    position: absolute; 
    right: 8px; 
    bottom: 8px; 
    background: rgba(0,0,0,0.7); 
    color: #fff; 
    font-size: 10px; 
    padding: 3px 8px; 
    border-radius: 12px; 
    backdrop-filter: blur(8px);
    font-weight: 500;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.grid-text { 
    position: absolute; 
    left: 0; 
    right: 0; 
    bottom: 0; 
    padding: 8px 12px; 
    font-size: 12px; 
    color: #fff; 
    background: linear-gradient(180deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.6) 100%); 
    max-height: 60px; 
    overflow: hidden; 
    display: -webkit-box; 
    -webkit-line-clamp: 2; 
    -webkit-box-orient: vertical;
    font-weight: 400;
    line-height: 1.4;
}

/* 顶部信息样式（时间和文字在同一行） */
.grid-info-top { 
    position: absolute; 
    top: 0; 
    left: 0; 
    right: 0; 
    padding: 12px 16px; 
    background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(248,250,252,0.9)); 
    backdrop-filter: blur(12px);
    z-index: 10;
    border-radius: 20px 20px 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    border-bottom: 1px solid rgba(102, 126, 234, 0.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    min-height: 44px;
}

/* 时间样式 - 紧贴文字左边，小标签风格 */
.grid-time-info {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 10px;
    color: white;
    font-weight: 600;
    letter-spacing: 0.3px;
    white-space: nowrap;
    background: linear-gradient(135deg, #667eea, #764ba2);
    padding: 5px 10px;
    border-radius: 14px;
    box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
    border: 1px solid rgba(255,255,255,0.2);
    flex-shrink: 0;
    margin-right: 8px;
}

/* 文字样式 - 紧贴时间右边，内容区域 */
.grid-text-info {
    flex: 1;
    font-size: 12px;
    color: #374151;
    font-weight: 500;
    line-height: 1.4;
    text-align: left;
    background: rgba(255,255,255,0.9);
    padding: 6px 12px;
    border-radius: 10px;
    border: 1px solid rgba(102, 126, 234, 0.1);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    backdrop-filter: blur(8px);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* 视频播放按钮样式 */
.video-play-btn { 
    position: absolute; 
    top: 50%; 
    left: 50%; 
    transform: translate(-50%, -50%); 
    width: 64px; 
    height: 64px; 
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #1e40af 100%); 
    border-radius: 50%; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    color: white; 
    font-size: 28px; 
    z-index: 4;
    transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    backdrop-filter: blur(12px);
    border: 4px solid rgba(255, 255, 255, 0.4);
    box-shadow: 
        0 8px 24px rgba(59, 130, 246, 0.4),
        0 4px 12px rgba(0, 0, 0, 0.15),
        0 2px 6px rgba(0, 0, 0, 0.1),
        inset 0 2px 0 rgba(255, 255, 255, 0.3),
        inset 0 -2px 0 rgba(0, 0, 0, 0.1);
}
.video-play-btn:hover {
    background: linear-gradient(135deg, #2563eb 0%, #1e40af 50%, #1e3a8a 100%);
    transform: translate(-50%, -50%) scale(1.25) rotate(5deg);
    box-shadow: 
        0 12px 32px rgba(59, 130, 246, 0.5),
        0 6px 16px rgba(0, 0, 0, 0.2),
        0 3px 8px rgba(0, 0, 0, 0.15),
        inset 0 2px 0 rgba(255, 255, 255, 0.4),
        inset 0 -2px 0 rgba(0, 0, 0, 0.15);
}
.video-play-btn i {
    margin-left: 5px; /* 微调播放图标位置，使其更居中 */
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
@media (min-width: 768px) { 
    .grid { 
        grid-template-columns: repeat(4, 1fr); 
        gap: 24px; 
        padding: 28px; 
        margin: 20px 0;
    } 
}
@media (min-width: 992px) { 
    .grid { 
        grid-template-columns: repeat(5, 1fr); 
        gap: 28px; 
        padding: 32px; 
        margin: 24px 0;
    } 
}


@media (max-width: 768px) {
  .timeline::before { left:16px; }
  .timeline-item { padding-left:40px; }
  .timeline-dot { left:10px; }
  .moment-text { -webkit-line-clamp:4; font-size:14px; }
  /* 移动端降级：关闭 3D 透视与厚重阴影，使用轻量滑动 */
  .viewer { perspective: none; }
  .book { box-shadow: var(--shadow-sm); }
  
  /* 移动端网格优化 */
  .grid { 
    gap: 16px; 
    padding: 20px; 
    margin: 12px 0;
    border-radius: 20px;
  }
  .grid-item { 
    border-radius: 18px !important; 
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%) !important;
    box-shadow: 
        0 3px 12px rgba(0,0,0,0.1),
        0 2px 6px rgba(0,0,0,0.08),
        0 1px 3px rgba(0,0,0,0.12),
        inset 0 1px 0 rgba(255,255,255,0.8),
        inset 0 -1px 0 rgba(0,0,0,0.05) !important;
  }
  .grid-item:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 
        0 8px 20px rgba(0,0,0,0.15),
        0 4px 10px rgba(0,0,0,0.1),
        inset 0 1px 0 rgba(255,255,255,1);
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <!-- 简洁顶部导航 -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrow-left me-1"></i>返回首页
    </a>
    
    <!-- 搜索框 -->
    <div class="flex-grow-1 mx-3">
      <div class="input-group input-group-sm">
        <span class="input-group-text">
          <i class="bi bi-search"></i>
        </span>
        <input type="text" id="searchInput" class="form-control" placeholder="搜索时光记录..." 
               style="border-radius: 0 6px 6px 0;">
      </div>
    </div>
    
    <div class="d-flex gap-2">
      <div class="dropdown">
        <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          <i class="bi bi-sliders"></i>
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <a class="dropdown-item" href="#" onclick="sortByTime('desc')">
              <i class="bi bi-sort-down me-2"></i>最新优先
            </a>
          </li>
          <li>
            <a class="dropdown-item" href="#" onclick="sortByTime('asc')">
              <i class="bi bi-sort-up me-2"></i>最早优先
            </a>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <a class="dropdown-item" href="#" onclick="filterFavorites()">
              <i class="bi bi-heart-fill me-2" style="color: #dc3545;"></i>只看收藏
            </a>
          </li>
          <li>
            <a class="dropdown-item" href="#" onclick="showAll()">
              <i class="bi bi-list me-2"></i>显示全部
            </a>
          </li>
        </ul>
      </div>
      <a href="{{ url_for('create_moment') }}" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-camera-fill"></i>
      </a>
    </div>
  </div>
  
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-8">

            {% if groups %}
                <!-- 朋友圈式垂直列表 -->
                <div class="moments-list">
                  {% for g in groups %}
                    {% for moment in g['items'] %}
                      <div class="moment-item" data-favorite="{{ moment.is_favorite|lower }}">
                        <a href="{{ url_for('moment_detail', moment_id=moment.id) }}" class="moment-link">
                          <div class="moment-header">
                            <div class="moment-time">{{ moment.timestamp.strftime('%m月%d日 %H:%M') }}</div>
                            {% if moment.is_favorite %}
                              <i class="bi bi-heart-fill favorite-icon"></i>
                            {% endif %}
                          </div>
                          
                          {% if moment.content %}
                            <div class="moment-content">{{ moment.content }}</div>
                          {% endif %}
                          
                          {% if moment.video_path or moment.thumb_path or moment.image_path %}
                            <div class="moment-media">
                              {% if moment.video_path %}
                                <div class="media-container">
                                  <video class="media-video" autoplay muted loop playsinline>
                                    <source src="{{ url_for('static', filename=moment.video_path) }}" type="video/mp4">
                                    <source src="{{ url_for('static', filename=moment.video_path) }}" type="video/webm">
                                    您的浏览器不支持视频播放。
                                  </video>
                                  <div class="video-controls">
                                    <i class="bi bi-play-circle-fill play-icon"></i>
                                    <i class="bi bi-pause-circle-fill pause-icon" style="display: none;"></i>
                                  </div>
                                </div>
                              {% elif moment.thumb_path or moment.image_path %}
                                <div class="media-container">
                                  <img src="{{ url_for('static', filename=moment.thumb_path or moment.image_path) }}" alt="" class="media-image">
                                </div>
                              {% endif %}
                            </div>
                          {% endif %}
                        </a>
                      </div>
                    {% endfor %}
                  {% endfor %}
                </div>

                

                {% if moments.pages > 1 %}
                <nav aria-label="时光分页">
                    <ul class="pagination justify-content-center">
                        {% if moments.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('moments', page=moments.prev_num) }}">上一页</a>
                        </li>
                        {% endif %}
                        {% for page_num in moments.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != moments.page %}
                                <li class="page-item"><a class="page-link" href="{{ url_for('moments', page=page_num) }}">{{ page_num }}</a></li>
                                {% else %}
                                <li class="page-item active"><span class="page-link">{{ page_num }}</span></li>
                                {% endif %}
                            {% else %}
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                            {% endif %}
                        {% endfor %}
                        {% if moments.has_next %}
                        <li class="page-item"><a class="page-link" href="{{ url_for('moments', page=moments.next_num) }}">下一页</a></li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <i class="bi bi-camera"></i>
                    <h5>还没有时光记录</h5>
                    <p>记录下宝宝的美好瞬间吧！</p>
                    <a href="{{ url_for('create_moment') }}" class="btn btn-primary">
                        <i class="bi bi-plus"></i> 发布第一条时光
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<a href="{{ url_for('create_moment') }}" class="create-btn" title="发布时光">
    <i class="bi bi-plus"></i>
</a>

{% block extra_scripts %}
<script>
// 时光列表排序和筛选功能
function sortByTime(order) {
  const momentsList = document.querySelector('.moments-list');
  if (!momentsList) return;
  
  const items = Array.from(momentsList.children);
  items.sort((a, b) => {
    const timeA = new Date(a.dataset.timestamp);
    const timeB = new Date(b.dataset.timestamp);
    return order === 'desc' ? timeB - timeA : timeA - timeB;
  });
  
  // 重新排列元素
  items.forEach(item => momentsList.appendChild(item));
  
  // 显示排序提示
  showToast(order === 'desc' ? '已按最新时间排序' : '已按最早时间排序');
}

function filterFavorites() {
  const items = document.querySelectorAll('.moment-item');
  items.forEach(item => {
    const isFavorite = item.dataset.favorite === 'true';
    item.style.display = isFavorite ? 'block' : 'none';
  });
  
  showToast('已筛选收藏时光');
}

function showAll() {
  const items = document.querySelectorAll('.moment-item');
  items.forEach(item => {
    item.style.display = 'block';
  });
  
  showToast('已显示全部时光');
}

// 简单的提示功能
function showToast(message) {
  // 创建提示元素
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.textContent = message;
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 12px 20px;
    border-radius: 6px;
    font-size: 14px;
    z-index: 9999;
    opacity: 0;
    transform: translateX(100%);
    transition: all 0.3s ease;
  `;
  
  document.body.appendChild(toast);
  
  // 显示动画
  setTimeout(() => {
    toast.style.opacity = '1';
    toast.style.transform = 'translateX(0)';
  }, 100);
  
  // 自动隐藏
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => {
      document.body.removeChild(toast);
    }, 300);
  }, 2000);
}

// 为每个时光项添加时间戳数据属性
document.addEventListener('DOMContentLoaded', function() {
  const items = document.querySelectorAll('.moment-item');
  items.forEach(item => {
    const timeElement = item.querySelector('.moment-time');
    if (timeElement) {
      const timeText = timeElement.textContent;
      // 解析时间文本为时间戳
      const timestamp = parseTimeText(timeText);
      if (timestamp) {
        item.dataset.timestamp = timestamp.toISOString();
      }
    }
  });
  
  // 初始化视频控制
  initVideoControls();
});

// 初始化视频控制功能
function initVideoControls() {
  const videoContainers = document.querySelectorAll('.media-container');
  
  videoContainers.forEach(container => {
    const video = container.querySelector('.media-video');
    const controls = container.querySelector('.video-controls');
    const playIcon = container.querySelector('.play-icon');
    const pauseIcon = container.querySelector('.pause-icon');
    
    if (video && controls && playIcon && pauseIcon) {
      // 点击控制按钮切换播放状态
      controls.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        if (video.paused) {
          video.play();
          playIcon.style.display = 'none';
          pauseIcon.style.display = 'block';
        } else {
          video.pause();
          playIcon.style.display = 'block';
          pauseIcon.style.display = 'none';
        }
      });
      
      // 视频播放状态变化时更新图标
      video.addEventListener('play', function() {
        playIcon.style.display = 'none';
        pauseIcon.style.display = 'block';
      });
      
      video.addEventListener('pause', function() {
        playIcon.style.display = 'block';
        pauseIcon.style.display = 'none';
      });
      
      // 鼠标悬停时显示控制按钮
      container.addEventListener('mouseenter', function() {
        controls.style.opacity = '1';
      });
      
      container.addEventListener('mouseleave', function() {
        if (!video.paused) {
          controls.style.opacity = '0';
        }
      });
    }
  });
}

// 解析时间文本为Date对象
function parseTimeText(timeText) {
  // 处理类似 "2024-01-15 14:30" 的时间格式
  const timeMatch = timeText.match(/(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2})/);
  if (timeMatch) {
    return new Date(timeMatch[1] + 'T' + timeMatch[2]);
  }
  return null;
}

// 懒加载功能
let currentPage = 1;
let isLoading = false;
let hasMore = true;

// 图片懒加载
function initLazyLoading() {
  const images = document.querySelectorAll('img[data-src]');
  const imageObserver = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        img.src = img.dataset.src;
        img.classList.remove('lazy');
        img.classList.add('loaded');
        observer.unobserve(img);
      }
    });
  });

  images.forEach(img => imageObserver.observe(img));
}

// 加载更多时光
async function loadMoreMoments() {
  if (isLoading || !hasMore) return;
  
  isLoading = true;
  currentPage++;
  
  try {
    const response = await fetch(`/api/moments/load?page=${currentPage}&per_page={{ per_page }}&favorite={{ favorite_only|lower }}`);
    const data = await response.json();
    
    if (data.moments.length === 0) {
      hasMore = false;
      return;
    }
    
    // 添加到页面
    const container = document.querySelector('.viewer-wrap');
    data.moments.forEach(moment => {
      const momentElement = createMomentElement(moment);
      container.appendChild(momentElement);
    });
    
    // 重新初始化懒加载
    initLazyLoading();
    
    hasMore = data.has_next;
  } catch (error) {
    console.error('加载更多时光失败:', error);
  } finally {
    isLoading = false;
  }
}

// 创建时光元素
function createMomentElement(moment) {
  const div = document.createElement('div');
  div.className = 'moment-item';
  div.innerHTML = `
    <div class="moment-card">
      <div class="moment-content">
        <p>${moment.content}</p>
        ${moment.image_path ? `
          <div class="moment-media">
            <img class="lazy" data-src="/static/moments/${moment.image_path}" alt="时光图片" 
                 style="max-width: 100%; height: auto; border-radius: 8px;">
          </div>
        ` : ''}
        ${moment.video_path ? `
          <div class="moment-media">
            <video class="lazy" data-src="/static/moments/${moment.video_path}" 
                   controls autoplay muted loop playsinline
                   style="max-width: 100%; height: auto; border-radius: 8px;">
            </video>
          </div>
        ` : ''}
      </div>
      <div class="moment-actions">
        <button class="btn btn-sm btn-outline-danger" onclick="toggleFavorite(${moment.id})">
          <i class="bi bi-heart${moment.is_favorite ? '-fill' : ''}"></i>
        </button>
      </div>
    </div>
  `;
  return div;
}

// 滚动加载更多
function initScrollLoading() {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting && hasMore && !isLoading) {
        loadMoreMoments();
      }
    });
  });
  
  // 观察页面底部的加载触发器
  const loadTrigger = document.createElement('div');
  loadTrigger.id = 'load-trigger';
  loadTrigger.style.height = '20px';
  document.querySelector('.viewer-wrap').appendChild(loadTrigger);
  
  observer.observe(loadTrigger);
}

// 搜索功能
let searchQuery = '';
let isSearchMode = false;

async function searchMoments(query) {
  if (!query.trim()) {
    // 清空搜索，返回正常模式
    isSearchMode = false;
    currentPage = 1;
    hasMore = true;
    location.reload();
    return;
  }
  
  searchQuery = query;
  isSearchMode = true;
  currentPage = 1;
  hasMore = true;
  
  try {
    const response = await fetch(`/api/moments/search?q=${encodeURIComponent(query)}&page=1&per_page={{ per_page }}`);
    const data = await response.json();
    
    // 清空当前内容
    const container = document.querySelector('.viewer-wrap');
    container.innerHTML = '';
    
    if (data.moments.length === 0) {
      container.innerHTML = '<div class="text-center p-4"><p>没有找到相关时光记录</p></div>';
      return;
    }
    
    // 显示搜索结果
    data.moments.forEach(moment => {
      const momentElement = createMomentElement(moment);
      container.appendChild(momentElement);
    });
    
    // 重新初始化懒加载
    initLazyLoading();
    
    hasMore = data.has_next;
  } catch (error) {
    console.error('搜索失败:', error);
  }
}

// 搜索输入处理
function initSearch() {
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    let searchTimeout;
    searchInput.addEventListener('input', function() {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        const query = this.value.trim();
        if (query.length >= 2 || query.length === 0) {
          searchMoments(query);
        }
      }, 500); // 防抖，500ms后执行搜索
    });
  }
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
  initLazyLoading();
  initScrollLoading();
  initSearch();
});

</script>
{% endblock %}

{% endblock %}

