{% extends 'base.html' %}
{% block content %}

<style>
/* ç–«è‹—æ ‡ç­¾é¡µæ ·å¼ */
.timeline {
  position: relative;
  padding-left: 30px;
}

.timeline-item {
  position: relative;
  margin-bottom: 20px;
}

.timeline-marker {
  position: absolute;
  left: -25px;
  top: 5px;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  border: 2px solid #fff;
  box-shadow: 0 0 0 2px #dee2e6;
}

.timeline-content {
  background: #f8f9fa;
  padding: 12px 16px;
  border-radius: 8px;
  border-left: 3px solid #dee2e6;
}

.timeline-item:not(:last-child)::before {
  content: '';
  position: absolute;
  left: -19px;
  top: 17px;
  width: 2px;
  height: calc(100% + 20px);
  background: #dee2e6;
}

/* å€’è®¡æ—¶æ ·å¼ */
.vaccine-countdown {
  font-weight: 600;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.85em;
}

.vaccine-countdown.urgent {
  background: #f8d7da;
  color: #721c24;
  animation: pulse 2s infinite;
}

.vaccine-countdown.warning {
  background: #fff3cd;
  color: #856404;
}

.vaccine-countdown.normal {
  background: #d1ecf1;
  color: #0c5460;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}
</style>

<ul class="nav nav-tabs" id="mainTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="nav-link active" id="feed-tab" data-bs-toggle="tab" href="#feed-pane" role="tab" aria-controls="feed-pane" aria-selected="true">ğŸ¼ å–‚å¥¶</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" id="diaper-tab" data-bs-toggle="tab" href="#diaper-pane" role="tab" aria-controls="diaper-pane" aria-selected="false">ğŸ’© æ¢å°¿å¸ƒ</a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link" id="vaccine-tab" data-bs-toggle="tab" href="#vaccine-pane" role="tab" aria-controls="vaccine-pane" aria-selected="false">ğŸ’‰ ç–«è‹—</a>
  </li>
</ul>

<div class="tab-content mt-3" id="mainTabsContent">
  <div class="tab-pane fade show active" id="feed-pane" role="tabpanel" aria-labelledby="feed-tab" tabindex="0">
    <div class="card mb-2">
      <div class="card-body p-2">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h6 class="m-0">ğŸ¼ å–‚å¥¶</h6>
          <small class="text-muted">è·ä¸Šæ¬¡ <strong id="feedElapsed">{{ feed_elapsed or '--:--' }}</strong></small>
        </div>
        <small class="text-muted d-block mb-2">ä¸Šæ¬¡ï¼š<span id="lastFeedText">{{ last_feed_time or 'è¿˜æ²¡æœ‰è®°å½•' }}</span></small>


        <form action="{{ url_for('main.record_feed') }}" method="post" class="row g-2" onsubmit="this.querySelector('button[type=submit]').disabled=true;">
<div class="col-6">
            <input name="amount_ml" type="number" class="form-control form-control-sm" placeholder="æ¯«å‡ (ml)" min="10" max="1000" required>
          </div>
          <div class="col-6 d-flex gap-2">
            <button class="btn btn-success btn-sm flex-fill" type="submit">è®°å½•</button>
            <button class="btn btn-outline-secondary btn-sm" type="button" id="undoBtn">æ’¤é”€</button>
          </div>
          <div class="col-12">
            <div class="d-flex flex-wrap gap-1 mt-1" id="presetContainer"></div>
            <div class="d-flex align-items-center gap-3 mt-1">
              <button id="editPresetsBtn" class="btn btn-link btn-sm p-0" type="button">ç¼–è¾‘é€‰é¡¹</button>
            </div>
            <div id="presetEditor" class="d-none mt-1">
              <div class="d-flex gap-2 flex-wrap">
                <input type="number" class="form-control form-control-sm" style="width:72px" id="p0" min="1" placeholder="ml">
                <input type="number" class="form-control form-control-sm" style="width:72px" id="p1" min="1" placeholder="ml">
                <input type="number" class="form-control form-control-sm" style="width:72px" id="p2" min="1" placeholder="ml">
                <input type="number" class="form-control form-control-sm" style="width:72px" id="p3" min="1" placeholder="ml">
                <button id="savePresetsBtn" class="btn btn-primary btn-sm" type="button">ä¿å­˜</button>
                <button id="cancelPresetsBtn" class="btn btn-outline-secondary btn-sm" type="button">å–æ¶ˆ</button>
              </div>
              <small class="text-muted">å¯ç¼–è¾‘å¸¸ç”¨æ¯«å‡å€¼ï¼Œä¿å­˜åæŒ‰é’®ä¼šæ›´æ–°å¹¶è®°ä½ã€‚</small>
</div>
</div>
</form>

        <div class="d-flex justify-content-between align-items-center mt-2">
          <div class="d-flex gap-2">
            <a href="{{ url_for('main.history') }}" class="btn btn-outline-secondary btn-sm">æŸ¥çœ‹å†å²</a>
            <button id="refreshBtn" class="btn btn-outline-info btn-sm" onclick="location.reload()">åˆ·æ–°</button>
          </div>
          <small class="text-muted">ä»Šæ—¥ <strong>{{ today_feed_total_ml }} ml</strong> Â· <strong>{{ today_feed_count }}</strong> æ¬¡</small>
        </div>
</div>
</div>
</div>

  <div class="tab-pane fade" id="diaper-pane" role="tabpanel" aria-labelledby="diaper-tab" tabindex="0">
    <div class="card mb-2">
      <div class="card-body p-2">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <h6 class="m-0">ğŸ’© æ¢å°¿å¸ƒ</h6>
          <small class="text-muted">è·ä¸Šæ¬¡ <strong id="diaperElapsed">{{ diaper_elapsed or '--:--' }}</strong></small>
        </div>
        <small class="text-muted d-block mb-2">ä¸Šæ¬¡ï¼š<span id="lastDiaperText">{{ last_diaper_time or 'è¿˜æ²¡æœ‰è®°å½•' }}</span></small>
        <form action="{{ url_for('main.record_diaper') }}" method="post" class="row g-2">
          <div class="col-12">
            <div class="d-flex flex-wrap gap-2 mb-2">
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="diaper_kind" id="kind_pee" value="pee">
                <label class="form-check-label" for="kind_pee">å°¿</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="diaper_kind" id="kind_poop" value="poop">
                <label class="form-check-label" for="kind_poop">ä¾¿</label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="diaper_kind" id="kind_both" value="both">
                <label class="form-check-label" for="kind_both">å°¿+ä¾¿</label>
              </div>
            </div>
          </div>
          <div class="col-12">
            <button class="btn btn-primary w-100">è®°å½•æ¢å°¿å¸ƒ</button>
          </div>
        </form>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <div class="d-flex gap-2">
            <a href="{{ url_for('main.history') }}" class="btn btn-outline-secondary btn-sm">æŸ¥çœ‹å†å²</a>
            <button class="btn btn-outline-info btn-sm" onclick="location.reload()">åˆ·æ–°</button>
          </div>
          <small class="text-muted">ä»Šæ—¥ <strong>{{ today_diaper_count }}</strong> æ¬¡</small>
        </div>
        <hr>
        <h6 class="card-title mb-2">ğŸ“ˆ æœ€è¿‘æ¢å°¿å¸ƒè¶‹åŠ¿ï¼ˆ14å¤©ï¼‰</h6>
        <div id="diaperChartWrap" style="height:220px;">
          <canvas id="diaperChart" style="width:100%;height:100%"></canvas>
        </div>
        <div id="diaperChartEmpty" class="text-muted small" style="display:none;">æš‚æ— è®°å½•</div>
      </div>
    </div>
  </div>
  
  <!-- ç–«è‹—æ ‡ç­¾é¡µ -->
  <div class="tab-pane fade" id="vaccine-pane" role="tabpanel" aria-labelledby="vaccine-tab" tabindex="0">
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">ğŸ’‰ ç–«è‹—æ¥ç§</h5>
        
        <!-- ä¸‹æ¬¡æ¥ç§æé†’ -->
        <div class="alert alert-info mb-3">
          <div class="d-flex align-items-center">
            <i class="bi bi-bell me-2"></i>
            <div>
              <strong>ä¹™è‚ç–«è‹—ç¬¬äºŒé’ˆ</strong>
              <br>
              <small>é¢„è®¡æ¥ç§æ—¶é—´ï¼š<span id="nextVaccineDate">è®¡ç®—ä¸­...</span></small>
              <br>
              <small class="text-warning">å€’è®¡æ—¶ï¼š<span id="vaccineCountdown" class="vaccine-countdown warning">è¿˜æœ‰ 3 å¤©</span></small>
            </div>
          </div>
        </div>
        
        <!-- æ¥ç§è®¡åˆ’æ—¶é—´çº¿ -->
        <div class="mb-3">
          <h6 class="text-muted mb-2">æ¥ç§è®¡åˆ’</h6>
          <div class="timeline">
            <div class="timeline-item">
              <div class="timeline-marker bg-success"></div>
              <div class="timeline-content">
                <strong>å‡ºç”Ÿæ—¶</strong>
                <p class="mb-1">ä¹™è‚ç–«è‹—ç¬¬ä¸€é’ˆã€å¡ä»‹è‹—</p>
                <small class="text-success">âœ… å·²å®Œæˆ</small>
              </div>
            </div>
            <div class="timeline-item">
              <div class="timeline-marker bg-warning"></div>
              <div class="timeline-content">
                <strong>1ä¸ªæœˆ (<span id="hepatitisDate">è®¡ç®—ä¸­...</span>)</strong>
                <p class="mb-1">ä¹™è‚ç–«è‹—ç¬¬äºŒé’ˆ</p>
                <small class="text-warning">â° è¿˜æœ‰ <span id="hepatitisCountdown" class="vaccine-countdown warning">3 å¤©</span></small>
              </div>
            </div>
            <div class="timeline-item">
              <div class="timeline-marker bg-light"></div>
              <div class="timeline-content">
                <strong>2ä¸ªæœˆ (<span id="pentavalentDate">è®¡ç®—ä¸­...</span>)</strong>
                <p class="mb-1">äº”è”ç–«è‹—ç¬¬ä¸€é’ˆ</p>
                <small class="text-muted">ğŸ“… è¿˜æœ‰ <span id="pentavalentCountdown" class="vaccine-countdown normal">34 å¤©</span></small>
              </div>
            </div>
          </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="d-flex gap-2">
          <button class="btn btn-primary btn-sm" onclick="markVaccinated()">
            <i class="bi bi-check-circle me-1"></i>æ ‡è®°å·²æ¥ç§
          </button>
          <button class="btn btn-outline-secondary btn-sm" onclick="viewVaccineHistory()">
            <i class="bi bi-clock-history me-1"></i>æŸ¥çœ‹å†å²
          </button>
        </div>
</div>
</div>
</div>
</div>





<div id="feedTrendSection" class="row mt-3">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <h6 class="card-title mb-2">ğŸ§­ æœ€è¿‘å–‚å¥¶è¶‹åŠ¿</h6>
        <div id="feedChartWrap" style="height:240px;">
          <canvas id="feedChart" style="width:100%;height:100%"></canvas>
        </div>
        <div id="feedChartEmpty" class="text-muted small" style="display:none;">æš‚æ— å–‚å¥¶è®°å½•ï¼Œå…ˆå»ä¸Šé¢è®°å½•å‡ æ¬¡å§ï½</div>
        <div class="text-muted mt-2" style="font-size: 12px;">æç¤ºï¼šç‚¹å‡»æ¨ªè½´å¯å·¦å³æ»‘åŠ¨ï¼Œçºµè½´ä¸ºå¥¶é‡ï¼ˆmlï¼‰</div>
      </div>
</div>
</div>
</div>

<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// å®æ—¶æ›´æ–°ï¼š
// 1) â€œè·ç¦»ä¸Šæ¬¡â€æ”¹ä¸º æ—¶:åˆ†:ç§’ï¼Œæ¯ç§’æ›´æ–°
// 2) â€œä¸Šæ¬¡æ—¶é—´â€åœ¨å‰ç«¯ç»Ÿä¸€æ ¼å¼åŒ–ä¸º HH:MM:SSï¼ˆæœ¬åœ°æ—¶åŒºï¼‰
function startElapsedTicker() {
  const feedTs = {{ last_feed_ts|tojson }};
  const diaperTs = {{ last_diaper_ts|tojson }};

  function two(n){ return String(n).padStart(2,'0'); }
  function fmtClock(d){ return `${two(d.getHours())}:${two(d.getMinutes())}:${two(d.getSeconds())}`; }
  function fmtElapsedHMS(ms){
    if (ms < 0 || isNaN(ms)) return '--:--:--';
    const s = Math.floor(ms/1000);
    const h = Math.floor(s/3600);
    const m = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${two(h)}:${two(m)}:${two(ss)}`;
  }

  // é¦–æ¬¡æ¸²æŸ“ï¼šå°†"ä¸Šæ¬¡æ—¶é—´"ç»Ÿä¸€æ¸²æŸ“ä¸º HH:MM:SS
  if (feedTs) {
    const d = new Date(feedTs); // feedTs æ˜¯åŒ—äº¬æ—¶é—´ï¼Œç›´æ¥ä½¿ç”¨
    const n = document.getElementById('lastFeedText');
    if (n) n.textContent = fmtClock(d);
  }
  if (diaperTs) {
    const d = new Date(diaperTs);
    const n = document.getElementById('lastDiaperText');
    if (n) n.textContent = fmtClock(d);
  }

  function tick(){
    const now = Date.now();
    if (feedTs){
      const delta = now - Date.parse(feedTs);
      const el = document.getElementById('feedElapsed');
      if (el) el.textContent = fmtElapsedHMS(delta);
    }
    if (diaperTs){
      const delta = now - Date.parse(diaperTs);
      const el = document.getElementById('diaperElapsed');
      if (el) el.textContent = fmtElapsedHMS(delta);
    }
  }
  tick();
  setInterval(tick, 1000);
}
document.addEventListener('DOMContentLoaded', startElapsedTicker);
// åŠ è½½æœ€è¿‘å–‚å¥¶æ•°æ®å¹¶ç»˜å›¾
async function loadFeedTrend() {
  try {
    const res = await fetch('/api/feed_series?limit=30', { cache: 'no-store' });
    const json = await res.json();
    const items = json.items || [];
    if (!items.length) {
      document.getElementById('feedChartWrap').style.display = 'none';
      document.getElementById('feedChartEmpty').style.display = '';
      return;
    }
    const labels = items.map(i => new Date(i.ts).toLocaleString());
    const data = items.map(i => i.amount_ml || 0);

    const ctx = document.getElementById('feedChart');
    if (!ctx) return;
    new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'å–‚å¥¶ (ml)',
          data,
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13,110,253,0.15)',
          tension: 0.25,
          fill: true,
          pointRadius: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, title: { display: true, text: 'ml' } },
          x: { ticks: { maxRotation: 30, minRotation: 0 } }
        },
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false }
        }
      }
    });
  } catch (e) {
    console.error(e);
    const empty = document.getElementById('feedChartEmpty');
    if (empty) { empty.textContent = 'åŠ è½½è¶‹åŠ¿å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•'; empty.style.display = ''; }
  }
}

document.addEventListener('DOMContentLoaded', loadFeedTrend);
</script>

<script>
// å¯ç¼–è¾‘çš„å¸¸ç”¨æ¯«å‡é€‰é¡¹ï¼Œæœ¬åœ°å­˜å‚¨
function initEditablePresets(){
  const container = document.getElementById('presetContainer');
  const form = container ? container.closest('form') : null;
  const key = 'feed_presets_ml_v1';
  function getPresets(){
    try{
      const raw = localStorage.getItem(key);
      const arr = raw ? JSON.parse(raw) : [30,40,50,60];
      return (Array.isArray(arr) && arr.length) ? arr.slice(0,8) : [30,40,50,60];
    }catch{return [30,40,50,60];}
  }
  function setPresets(arr){
    const cleaned = (arr||[]).map(x=>parseInt(x,10)).filter(x=>!isNaN(x) && x>0);
    const uniq = Array.from(new Set(cleaned)).slice(0,8);
    localStorage.setItem(key, JSON.stringify(uniq.length?uniq:[30,40,50,60]));
  }
  function render(){
    if(!container) return;
    container.innerHTML = '';
    const presets = getPresets();
    presets.forEach(v => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-outline-secondary btn-sm';
      btn.textContent = v + ' ml';
      btn.addEventListener('click', ()=>{ if(form){ form.amount_ml.value = v; }});
      container.appendChild(btn);
    });
  }
  render();

  const editBtn = document.getElementById('editPresetsBtn');
  const editor = document.getElementById('presetEditor');
  const saveBtn = document.getElementById('savePresetsBtn');
  const cancelBtn = document.getElementById('cancelPresetsBtn');
  function fillInputs(){
    const vals = getPresets();
    for(let i=0;i<4;i++){
      const el = document.getElementById('p'+i);
      if(el) el.value = vals[i]!==undefined ? vals[i] : '';
    }
  }
  if(editBtn){
    editBtn.addEventListener('click', ()=>{
      if(editor){ editor.classList.toggle('d-none'); if(!editor.classList.contains('d-none')) fillInputs(); }
    });
  }
  if(saveBtn){
    saveBtn.addEventListener('click', ()=>{
      const vals = [];
      for(let i=0;i<4;i++){
        const el = document.getElementById('p'+i);
        if(el && el.value) vals.push(el.value);
      }
      setPresets(vals);
      render();
      if(editor) editor.classList.add('d-none');
    });
  }
  if(cancelBtn){
    cancelBtn.addEventListener('click', ()=>{ if(editor) editor.classList.add('d-none'); });
  }
}

document.addEventListener('DOMContentLoaded', initEditablePresets);
</script>
<script>
// æ’¤é”€æŒ‰é’®é€šè¿‡ fetch æäº¤ï¼Œé¿å…åœ¨è¡¨å•å†…åµŒå¥—å¦ä¸€ä¸ªè¡¨å•å¯¼è‡´ HTML æ¸²æŸ“é”™è¯¯
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('undoBtn');
  if(!btn) return;
  btn.addEventListener('click', async function(){
    try{
      const resp = await fetch('{{ url_for('main.undo_last') }}', { method: 'POST' });
      if(resp.redirected) { window.location.href = resp.url; return; }
      location.reload();
    }catch(e){ location.reload(); }
  });
});
</script>
<script>
// æ¢å°¿å¸ƒè¶‹åŠ¿ï¼šæŒ‰å¤©ç»Ÿè®¡ï¼ˆæ€»æ¬¡æ•°/å°¿/ä¾¿/å°¿+ä¾¿ï¼‰ï¼Œåœ¨åˆ‡åˆ°â€œæ¢å°¿å¸ƒâ€é¡µç­¾æ—¶åŠ è½½
async function drawDiaperTrend() {
  try {
    const res = await fetch('/api/diaper_series?days=14', { cache: 'no-store' });
    const json = await res.json();
    const items = json.items || [];
    if (!items.length) {
      const wrap = document.getElementById('diaperChartWrap');
      const empty = document.getElementById('diaperChartEmpty');
      if (wrap) wrap.style.display = 'none';
      if (empty) empty.style.display = '';
      return;
    }
    const labels = items.map(i => i.day.slice(5)); // MM-DD
    const total = items.map(i => i.total);
    const pee = items.map(i => i.pee);
    const poop = items.map(i => i.poop);
    const both = items.map(i => i.both);
    const ctx = document.getElementById('diaperChart');
    if (!ctx) return;
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'æ€»æ¬¡æ•°', data: total, backgroundColor: 'rgba(33,150,243,0.45)' },
          { label: 'å°¿', data: pee, backgroundColor: 'rgba(33,150,243,0.25)' },
          { label: 'ä¾¿', data: poop, backgroundColor: 'rgba(76,175,80,0.35)' },
          { label: 'å°¿+ä¾¿', data: both, backgroundColor: 'rgba(220,53,69,0.35)' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'top' } },
        scales: { y: { beginAtZero: true } }
      }
    });
  } catch (e) { console.error(e); }
}

document.addEventListener('DOMContentLoaded', function(){
  const diaperTab = document.getElementById('diaper-tab');
  if (!diaperTab) return;
  // åˆ‡åˆ°æ¢å°¿å¸ƒæ—¶éšè—å–‚å¥¶è¶‹åŠ¿
  const feedTrend = document.getElementById('feedTrendSection');
  const trigger = () => {
    if (typeof Chart === 'undefined') {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
      s.defer = true;
      s.onload = drawDiaperTrend;
      document.head.appendChild(s);
    } else {
      drawDiaperTrend();
    }
    if (feedTrend) feedTrend.style.display = 'none';
  };
  // bootstrap tab äº‹ä»¶
  diaperTab.addEventListener('shown.bs.tab', trigger, { once: true });
  // fallbackï¼šè‹¥æœªåŠ è½½åˆ° bootstrap
  if (!(window.bootstrap && bootstrap.Tab)) {
    diaperTab.addEventListener('click', trigger, { once: true });
  }
  // åˆ‡å›å–‚å¥¶æ—¶æ˜¾ç¤ºå–‚å¥¶è¶‹åŠ¿
  const feedTab = document.getElementById('feed-tab');
  const showFeed = () => { if (feedTrend) feedTrend.style.display = ''; };
  if (feedTab) {
    feedTab.addEventListener('shown.bs.tab', showFeed);
    if (!(window.bootstrap && bootstrap.Tab)) {
      feedTab.addEventListener('click', showFeed);
    }
  }
  
  // åˆ‡æ¢åˆ°ç–«è‹—æ—¶éšè—å–‚å¥¶è¶‹åŠ¿
  const vaccineTab = document.getElementById('vaccine-tab');
  const hideFeed = () => { if (feedTrend) feedTrend.style.display = 'none'; };
  if (vaccineTab) {
    vaccineTab.addEventListener('shown.bs.tab', hideFeed);
    if (!(window.bootstrap && bootstrap.Tab)) {
      vaccineTab.addEventListener('click', hideFeed);
    }
  }
});
</script>

<script>
// Fallbackï¼šè‹¥æŸäº›è®¾å¤‡æœªæ­£ç¡®åŠ è½½ Bootstrap JSï¼Œä½¿ç”¨åŸç”Ÿ JS åˆ‡æ¢æ ‡ç­¾
document.addEventListener('DOMContentLoaded', function () {
  if (window.bootstrap && bootstrap.Tab) return; // å·²åŠ è½½åˆ™è·³è¿‡
  const tabs = document.querySelectorAll('#mainTabs .nav-link');
  const panes = document.querySelectorAll('#mainTabsContent .tab-pane');
  tabs.forEach(link => {
    link.addEventListener('click', function (e) {
      e.preventDefault();
      const targetSel = this.getAttribute('href');
      tabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      panes.forEach(p => p.classList.remove('show', 'active'));
      const pane = document.querySelector(targetSel);
      if (pane) { pane.classList.add('show', 'active'); }
    }, { passive: false });
  });
});

// ç–«è‹—ç›¸å…³åŠŸèƒ½
function markVaccinated() {
  alert('æ ‡è®°å·²æ¥ç§åŠŸèƒ½å¼€å‘ä¸­...');
}

function viewVaccineHistory() {
  alert('æŸ¥çœ‹å†å²åŠŸèƒ½å¼€å‘ä¸­...');
}

// ç–«è‹—å€’è®¡æ—¶åŠŸèƒ½
async function updateVaccineCountdown() {
  // è·å–æœåŠ¡å™¨æ—¶é—´
  let now;
  try {
    const response = await fetch('/api/server_time');
    const data = await response.json();
    now = new Date(data.server_time);
  } catch (error) {
    console.warn('æ— æ³•è·å–æœåŠ¡å™¨æ—¶é—´ï¼Œä½¿ç”¨æœ¬åœ°æ—¶é—´');
    now = new Date();
  }
  
  // ä»æœåŠ¡å™¨è·å–å®å®å‡ºç”Ÿæ—¥æœŸï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
  const babyBirthDate = new Date('{{ baby_birth or "2024-09-14" }}');
  
  // è®¡ç®—ä¹™è‚ç–«è‹—ç¬¬äºŒé’ˆæ—¶é—´ï¼ˆå‡ºç”Ÿå1ä¸ªæœˆï¼‰
  const hepatitisDate = new Date(babyBirthDate);
  hepatitisDate.setMonth(hepatitisDate.getMonth() + 1);
  const hepatitisDiff = hepatitisDate - now;
  const hepatitisDays = Math.ceil(hepatitisDiff / (1000 * 60 * 60 * 24));
  
  // è®¡ç®—äº”è”ç–«è‹—ç¬¬ä¸€é’ˆæ—¶é—´ï¼ˆå‡ºç”Ÿå2ä¸ªæœˆï¼‰
  const pentavalentDate = new Date(babyBirthDate);
  pentavalentDate.setMonth(pentavalentDate.getMonth() + 2);
  const pentavalentDiff = pentavalentDate - now;
  const pentavalentDays = Math.ceil(pentavalentDiff / (1000 * 60 * 60 * 24));
  
  // ä½¿ç”¨ç»Ÿä¸€çš„æ˜¾ç¤ºæ›´æ–°é€»è¾‘
  updateCountdownDisplay(hepatitisDate, pentavalentDate, hepatitisDays, pentavalentDays);
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–å€’è®¡æ—¶
document.addEventListener('DOMContentLoaded', function() {
  // å¤„ç†URLé”šç‚¹ï¼Œæ¿€æ´»å¯¹åº”çš„æ ‡ç­¾é¡µï¼ˆä¼˜å…ˆæ‰§è¡Œï¼‰
  const hash = window.location.hash;
  if (hash) {
    const tabElement = document.querySelector(`a[href="${hash}"]`);
    if (tabElement) {
      // ä½¿ç”¨Bootstrapçš„Tab APIæ¿€æ´»æ ‡ç­¾é¡µ
      const tab = new bootstrap.Tab(tabElement);
      tab.show();
    }
  }
  
  updateVaccineCountdown().catch(error => {
    console.error('ç–«è‹—å€’è®¡æ—¶åˆå§‹åŒ–å¤±è´¥:', error);
    // å¦‚æœå¼‚æ­¥è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨åŒæ­¥ç‰ˆæœ¬
    updateVaccineCountdownSync();
  });
  // æ¯å°æ—¶æ›´æ–°ä¸€æ¬¡å€’è®¡æ—¶
  setInterval(() => {
    updateVaccineCountdown().catch(error => {
      console.error('ç–«è‹—å€’è®¡æ—¶æ›´æ–°å¤±è´¥:', error);
    });
  }, 60 * 60 * 1000);
});

// å¤„ç†URLé”šç‚¹çš„ç‹¬ç«‹å‡½æ•°ï¼Œç¡®ä¿åœ¨å…¶ä»–äº‹ä»¶ä¹‹å‰æ‰§è¡Œ
function handleUrlHash() {
  const hash = window.location.hash;
  if (hash) {
    const tabElement = document.querySelector(`a[href="${hash}"]`);
    if (tabElement) {
      // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿Bootstrapå·²åŠ è½½
      setTimeout(() => {
        const tab = new bootstrap.Tab(tabElement);
        tab.show();
      }, 100);
    }
  }
}

// ç«‹å³æ‰§è¡ŒURLé”šç‚¹å¤„ç†
handleUrlHash();

// åŒæ­¥ç‰ˆæœ¬çš„å€’è®¡æ—¶å‡½æ•°ï¼ˆå¤‡ç”¨ï¼‰
function updateVaccineCountdownSync() {
  const now = new Date();
  const babyBirthDate = new Date('{{ baby_birth or "2024-09-14" }}');
  
  // è®¡ç®—ç–«è‹—æ—¶é—´
  const hepatitisDate = new Date(babyBirthDate);
  hepatitisDate.setMonth(hepatitisDate.getMonth() + 1);
  const hepatitisDiff = hepatitisDate - now;
  const hepatitisDays = Math.ceil(hepatitisDiff / (1000 * 60 * 60 * 24));
  
  const pentavalentDate = new Date(babyBirthDate);
  pentavalentDate.setMonth(pentavalentDate.getMonth() + 2);
  const pentavalentDiff = pentavalentDate - now;
  const pentavalentDays = Math.ceil(pentavalentDiff / (1000 * 60 * 60 * 24));
  
  // æ›´æ–°æ˜¾ç¤ºï¼ˆä½¿ç”¨ç›¸åŒçš„é€»è¾‘ï¼‰
  updateCountdownDisplay(hepatitisDate, pentavalentDate, hepatitisDays, pentavalentDays);
}

// æå–æ˜¾ç¤ºæ›´æ–°é€»è¾‘
function updateCountdownDisplay(hepatitisDate, pentavalentDate, hepatitisDays, pentavalentDays) {
  // æ›´æ–°æ—¥æœŸæ˜¾ç¤º
  const nextVaccineDateEl = document.getElementById('nextVaccineDate');
  const hepatitisDateEl = document.getElementById('hepatitisDate');
  const pentavalentDateEl = document.getElementById('pentavalentDate');
  
  if (nextVaccineDateEl) {
    nextVaccineDateEl.textContent = hepatitisDate.toLocaleDateString('zh-CN');
  }
  if (hepatitisDateEl) {
    hepatitisDateEl.textContent = hepatitisDate.toLocaleDateString('zh-CN');
  }
  if (pentavalentDateEl) {
    pentavalentDateEl.textContent = pentavalentDate.toLocaleDateString('zh-CN');
  }
  
  // æ›´æ–°å€’è®¡æ—¶æ˜¾ç¤º
  const hepatitisCountdown = document.getElementById('hepatitisCountdown');
  const pentavalentCountdown = document.getElementById('pentavalentCountdown');
  const vaccineCountdown = document.getElementById('vaccineCountdown');
  
  if (hepatitisCountdown) {
    if (hepatitisDays > 7) {
      hepatitisCountdown.textContent = `${hepatitisDays} å¤©`;
      hepatitisCountdown.className = 'vaccine-countdown normal';
    } else if (hepatitisDays > 0) {
      hepatitisCountdown.textContent = `${hepatitisDays} å¤©`;
      hepatitisCountdown.className = 'vaccine-countdown warning';
    } else if (hepatitisDays === 0) {
      hepatitisCountdown.textContent = 'ä»Šå¤©';
      hepatitisCountdown.className = 'vaccine-countdown urgent';
    } else {
      hepatitisCountdown.textContent = `å·²é€¾æœŸ ${Math.abs(hepatitisDays)} å¤©`;
      hepatitisCountdown.className = 'vaccine-countdown urgent';
    }
  }
  
  if (pentavalentCountdown) {
    if (pentavalentDays > 7) {
      pentavalentCountdown.textContent = `${pentavalentDays} å¤©`;
      pentavalentCountdown.className = 'vaccine-countdown normal';
    } else if (pentavalentDays > 0) {
      pentavalentCountdown.textContent = `${pentavalentDays} å¤©`;
      pentavalentCountdown.className = 'vaccine-countdown warning';
    } else if (pentavalentDays === 0) {
      pentavalentCountdown.textContent = 'ä»Šå¤©';
      pentavalentCountdown.className = 'vaccine-countdown urgent';
    } else {
      pentavalentCountdown.textContent = `å·²é€¾æœŸ ${Math.abs(pentavalentDays)} å¤©`;
      pentavalentCountdown.className = 'vaccine-countdown urgent';
    }
  }
  
  if (vaccineCountdown) {
    if (hepatitisDays > 7) {
      vaccineCountdown.textContent = `è¿˜æœ‰ ${hepatitisDays} å¤©`;
      vaccineCountdown.className = 'vaccine-countdown normal';
    } else if (hepatitisDays > 0) {
      vaccineCountdown.textContent = `è¿˜æœ‰ ${hepatitisDays} å¤©`;
      vaccineCountdown.className = 'vaccine-countdown warning';
    } else if (hepatitisDays === 0) {
      vaccineCountdown.textContent = 'ä»Šå¤©æ¥ç§';
      vaccineCountdown.className = 'vaccine-countdown urgent';
    } else {
      vaccineCountdown.textContent = `å·²é€¾æœŸ ${Math.abs(hepatitisDays)} å¤©`;
      vaccineCountdown.className = 'vaccine-countdown urgent';
    }
  }
}
</script>


{% endblock %}