{% extends "base.html" %}

{% block title %}AIè‚²å„¿åŠ©æ‰‹{% endblock %}

{% block extra_styles %}
<style>
.ai-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.ai-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    overflow: hidden;
}

.ai-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    text-align: center;
}

.ai-content {
    padding: 20px;
}

.chat-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8fafc;
}

.chat-message {
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 10px;
    max-width: 80%;
}

.user-message {
    background: #667eea;
    color: white;
    margin-left: auto;
    text-align: right;
}

.ai-message {
    background: white;
    border: 1px solid #e2e8f0;
    margin-right: auto;
}

.input-group {
    display: flex;
    gap: 10px;
}

.input-group input {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    font-size: 14px;
}

.input-group button {
    padding: 12px 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
}

.input-group button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.ai-features {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.feature-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.feature-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.feature-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    color: #667eea;
}

.loading {
    display: none;
    text-align: center;
    color: #667eea;
}

.spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="ai-container">
    <!-- AIåŠ©æ‰‹æ ‡é¢˜ -->
    <div class="ai-card">
        <div class="ai-header">
            <h2><span style="font-weight: bold; color: #007bff;">AI</span> è‚²å„¿åŠ©æ‰‹</h2>
            <p>ä¸“ä¸šçš„è‚²å„¿å»ºè®®å’Œæ™ºèƒ½åˆ†æ</p>
        </div>
    </div>

    <!-- AIèŠå¤©åŠŸèƒ½ -->
    <div class="ai-card">
        <div class="ai-content">
            <h4><i class="bi bi-chat-dots"></i> æ™ºèƒ½é—®ç­”</h4>
            <div class="chat-container" id="chatContainer">
                <div class="chat-message ai-message">
                    <strong>AIåŠ©æ‰‹ï¼š</strong>æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“å±è‚²å„¿åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆè‚²å„¿é—®é¢˜å¯ä»¥éšæ—¶é—®æˆ‘å“¦ï¼
                </div>
            </div>
            <div class="input-group">
                <input type="text" id="questionInput" placeholder="è¯·è¾“å…¥æ‚¨çš„è‚²å„¿é—®é¢˜..." maxlength="200">
                <button onclick="askQuestion()">
                    <i class="bi bi-send"></i> å‘é€
                </button>
            </div>
            <div class="loading" id="chatLoading">
                <div class="spinner"></div>
                <span>AIæ­£åœ¨æ€è€ƒä¸­...</span>
            </div>
        </div>
    </div>

    <!-- AIåŠŸèƒ½å¡ç‰‡ -->
    <div class="ai-features">
        <div class="feature-card" onclick="analyzeMoments()">
            <div class="feature-icon">
                <i class="bi bi-graph-up"></i>
            </div>
            <h5>æˆé•¿åˆ†æ</h5>
            <p>AIåˆ†æå®å®çš„æˆé•¿è®°å½•ï¼Œæä¾›ä¸“ä¸šè§‚å¯Ÿå’Œå»ºè®®</p>
        </div>

        <div class="feature-card" onclick="getHealthAdvice()">
            <div class="feature-icon">
                <i class="bi bi-heart-pulse"></i>
            </div>
            <h5>å¥åº·å»ºè®®</h5>
            <p>åŸºäºå®å®å¹´é¾„å’Œå–‚å…»æƒ…å†µï¼Œæä¾›ä¸ªæ€§åŒ–å¥åº·å»ºè®®</p>
        </div>

        <div class="feature-card" onclick="showQuickTips()">
            <div class="feature-icon">
                <i class="bi bi-lightbulb"></i>
            </div>
            <h5>è‚²å„¿è´´å£«</h5>
            <p>è·å–å®ç”¨çš„è‚²å„¿æŠ€å·§å’Œæ³¨æ„äº‹é¡¹</p>
        </div>
    </div>

    <!-- åˆ†æç»“æœåŒºåŸŸ -->
    <div class="ai-card" id="analysisResult" style="display: none;">
        <div class="ai-content">
            <h4><i class="bi bi-bar-chart"></i> åˆ†æç»“æœ</h4>
            <div id="analysisContent"></div>
        </div>
    </div>
</div>

<script>
// å‘é€é—®é¢˜
async function askQuestion() {
    const input = document.getElementById('questionInput');
    const question = input.value.trim();
    
    if (!question) {
        alert('è¯·è¾“å…¥é—®é¢˜');
        return;
    }
    
    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    addMessage(question, 'user');
    input.value = '';
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showLoading('chatLoading');
    
    try {
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ question: question })
        });
        
        const data = await response.json();
        
        if (data.success) {
            addMessage(data.answer, 'ai');
        } else {
            addMessage('æŠ±æ­‰ï¼ŒAIåŠ©æ‰‹æš‚æ—¶æ— æ³•å›ç­”ï¼Œè¯·ç¨åå†è¯•ã€‚', 'ai');
        }
    } catch (error) {
        addMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•ã€‚', 'ai');
    } finally {
        hideLoading('chatLoading');
    }
}

// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©å®¹å™¨
function addMessage(message, type) {
    const container = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}-message`;
    
    if (type === 'user') {
        messageDiv.innerHTML = `<strong>æ‚¨ï¼š</strong>${message}`;
    } else {
        messageDiv.innerHTML = `<strong>AIåŠ©æ‰‹ï¼š</strong>${message}`;
    }
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

// åˆ†ææ—¶å…‰è®°å½•
async function analyzeMoments() {
    showLoading('analysisResult');
    
    try {
        const response = await fetch('/api/ai/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('analysisContent').innerHTML = data.analysis.replace(/\n/g, '<br>');
            document.getElementById('analysisResult').style.display = 'block';
        } else {
            document.getElementById('analysisContent').innerHTML = 'åˆ†æå¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚';
            document.getElementById('analysisResult').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('analysisContent').innerHTML = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•ã€‚';
        document.getElementById('analysisResult').style.display = 'block';
    } finally {
        hideLoading('analysisResult');
    }
}

// è·å–å¥åº·å»ºè®®
async function getHealthAdvice() {
    showLoading('analysisResult');
    
    try {
        const response = await fetch('/api/ai/health', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('analysisContent').innerHTML = data.advice.replace(/\n/g, '<br>');
            document.getElementById('analysisResult').style.display = 'block';
        } else {
            document.getElementById('analysisContent').innerHTML = 'è·å–å»ºè®®å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚';
            document.getElementById('analysisResult').style.display = 'block';
        }
    } catch (error) {
        document.getElementById('analysisContent').innerHTML = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•ã€‚';
        document.getElementById('analysisResult').style.display = 'block';
    } finally {
        hideLoading('analysisResult');
    }
}

// æ˜¾ç¤ºå¿«é€Ÿè´´å£«
function showQuickTips() {
    const tips = [
        "ğŸ’¡ å®å®å“­é—¹æ—¶ï¼Œå¯ä»¥å°è¯•è½»æŸ”çš„æŠšæ‘¸å’Œè½»å£°å®‰æ…°",
        "ğŸ¼ å–‚å¥¶åè®°å¾—ç»™å®å®æ‹å—ï¼Œé¿å…åå¥¶",
        "ğŸ˜´ å»ºç«‹è§„å¾‹çš„ç¡çœ æ—¶é—´ï¼Œæœ‰åŠ©äºå®å®å¥åº·æˆé•¿",
        "ğŸ§¸ å¤šä¸å®å®äº’åŠ¨ï¼Œä¿ƒè¿›å¤§è„‘å‘è‚²",
        "ğŸŒ¡ï¸ å®šæœŸæµ‹é‡ä½“æ¸©ï¼Œæ³¨æ„å®å®çš„èº«ä½“çŠ¶å†µ",
        "ğŸ‘¶ ä¿æŒå®å®å‘¨å›´ç¯å¢ƒæ¸…æ´ï¼Œé¢„é˜²æ„ŸæŸ“"
    ];
    
    const randomTip = tips[Math.floor(Math.random() * tips.length)];
    addMessage(randomTip, 'ai');
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'block';
    }
}

// éšè—åŠ è½½çŠ¶æ€
function hideLoading(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'none';
    }
}

// å›è½¦å‘é€æ¶ˆæ¯
document.getElementById('questionInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        askQuestion();
    }
});

</script>
{% endblock %}
